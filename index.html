<html>
  <head>
    <title>Snowpack Prototype</title>
    <style>
      #map { height: 800px; width: 100%; }
    </style>
  </head>

  <div class="controls">
    <label for="kmlUrl"><strong>KML URL:</strong></label>
    <input type="text" id="kmlUrl" placeholder="https://example.com/data.kml" value="https://cloudkj.s3.us-east-1.amazonaws.com/snow.kml">
    <button onclick="loadKML()">Add Layer</button>

    <label for="heatmapUrl"><strong>Heatmap GeoJSON URL:</strong></label>
    <input type="text" id="heatmapUrl" placeholder="https://example.com/data.json" value="https://cloudkj.s3.us-east-1.amazonaws.com/snow_depth.geojson">
    <button onclick="loadData()">Add Layer</button>
  </div>
  <div id="messages"></div>
  <div id="map"></div>
  
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&libraries=visualization&callback=initMap"></script>
  <script type="text/javascript">
    let map;    

    function info(message) {
        document.getElementById("messages").innerHTML += message;
    }

    function error(message) {
        console.log(message);
    }

    // Sierra Nevada Bounding Box
    const BBOX = {
        minLat: 38.0,
        maxLat: 40.0,
        minLon: -121.5,
        maxLon: -119.0
    };
    
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 2,
            restriction: {
                latLngBounds: {
                    north: BBOX.maxLat,
                    south: BBOX.minLat,
                    west: BBOX.minLon,
                    east: BBOX.maxLon
                },
                strictBounds: true, // Optional: prevents the viewport from showing any gray area outside the bounds
            },
            center: { lat: 38.5, lng: -120.0 }      
        });
    }

    async function loadData() {
        const url = document.getElementById("heatmapUrl").value.trim();
        try {
            info("Loading " + url);
            const response = await fetch(url);
            const geojson = await response.json();
            info("Loaded " + geojson.features.length + " features");

            // Filter features based on coordinates
            const filteredFeatures = geojson.features.filter(feature => {
                const [lon, lat] = feature.geometry.coordinates;
                return (lat >= BBOX.minLat && lat <= BBOX.maxLat) &&
                    (lon >= BBOX.minLon && lon <= BBOX.maxLon);
            });
            info("Filtered to " + filteredFeatures.length + " features");

            const heatmapData = filteredFeatures.map(f => {
                return {
                    location: new google.maps.LatLng(f.geometry.coordinates[1], f.geometry.coordinates[0]),
                    weight: f.properties.depth_mm
                };
            });

            const heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map,
                radius: 15,  // Adjust based on zoom
                opacity: 0.8
            });
            
        } catch (e) {
            error("Error filtering data:", e);
        }
    }

    function loadKML() {
        const url = document.getElementById("kmlUrl").value.trim();
        if (!url) {
            error("Invalid URL");
            return;
        }

        const kmlLayer = new google.maps.KmlLayer({
            url: url,
            map: map,
            preserveViewport: true
        });

        kmlLayer.addListener('status_changed', () => {
            if (kmlLayer.getStatus() !== 'OK') {
                error('KML Error: ' + kmlLayer.getStatus() + '; ensure the URL is public and ends in .kml or .kmz');
                kmlLayer.setMap(null);
            }
        });
    }
  </script>
</html>
